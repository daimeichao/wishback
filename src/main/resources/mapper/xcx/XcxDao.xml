<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jiading.modules.xcx.dao.XcxDao">


    <select id="getWishList" resultType="map">
        select
        pid,
        wishusername,
        wishuserid,
        adder,
        money,
        wish_time,
        wish_content,
        wish_audit_state,
        wish_audit_remark,
        wish_auditid,
        wish_state,
        operatorid,
        add_time,
        update_time,
        (select portrait from t_user where  pid = wishuserid)as userIcon
        from t_wish
        where wish_audit_state =1 and wish_state=0 and del=0
        order by sort asc, add_time desc
        <if test="pageindex != null and pagesize != null">
            LIMIT #{pageindex},#{pagesize}
        </if>
    </select>
<!--积分排行榜-->
    <select id="getphb" resultType="map">
        select u.name,u.portrait,sum(j.changenum)as zf ,j.userid ,j.pid as jid from t_jf j  left join t_user u on u.pid=j.userid where u.del='0' and j.del='0' and j.change1='0'
        <if test="name != null and name != '' ">
            and name LIKE CONCAT('%',#{name},'%')
        </if>
        group
        by userid
        <if test="pageindex != null and pagesize != null">
            LIMIT #{pageindex},#{pagesize}
        </if>
    </select>
    <select id="getphbCount" resultType="int">
        select
            count(*)
        from t_jf j  left join t_user u on u.pid=j.userid where u.del='0' and j.del='0' and j.change1='0'

        <if test="name != null and name != '' ">
            and name LIKE CONCAT('%',#{name},'%')
        </if>
    </select>
    <select id="getWishCount" resultType="int">
        select
        count(*)
        from t_wish
        where wish_audit_state =1 and wish_state=0 and del=0
    </select>





    <select id="getWishDetail" resultType="map">
        select
        pid,
        wishusername,
        wishuserid,
        adder,
        DATE_FORMAT(wish_time ,'%Y-%m-%d %H:%i:%S') as wish_time,
        wish_content,
        wish_audit_state,
        wish_audit_remark,
        wish_auditid,
        wish_state,
        operatorid,
        add_time,
        update_time,
        money
        from t_wish
        where pid=#{pid}
    </select>


    <insert id="realizationWish" useGeneratedKeys="true" keyProperty="pid">
        insert into t_wish_claimant(
        wishid,
        claimant,
        claimantid,
        realize_time,
        expressage,
        claimant_audit_remark,
        add_time)
        values(
        #{wishid},
        #{claimant},
        #{claimantid},
        #{realize_time},
        #{expressage},
        #{claimant_audit_remark},
        now()
        )
    </insert>

    <insert id="addWish" useGeneratedKeys="true" keyProperty="pid">
        insert into t_wish(
        wishusername,
        wishuserid,
        wish_content,
        adder,
        wish_time,
        wish_audit_remark,
        add_time,
        money
        )
        values(
        #{wishusername},
        #{wishuserid},
        #{wish_content},
        #{adder},
        now(),
        #{wish_audit_remark},
        now(),
        #{money}
        )
    </insert>

    <insert id="addFile">
        insert into t_wish_file(
        wishid,
        name,
        url,
        add_time
        )
        values
        (
        #{wishid},
        #{name},
        #{url},
        now()
        )


    </insert>


    <insert id="addUser" useGeneratedKeys="true" keyProperty="pid">
        insert into t_user(name,nick,portrait,phone,account,password,openid,type,add_time)
        values(
        #{name},
        #{nick},
        #{portrait},
        #{phone},
        #{account},
        #{password},
        #{openid},
        1,
        now()
        )
    </insert>
<insert id="dejf" parameterType="map">
    insert into t_jf (userid,remark,changenum,change1,add_time,del)
    values (#{userid},#{remark},#{changenum},'1',now(),'0')
</insert>
    <update id="updkc" parameterType="map">
        update t_sp  set kc=#{kc} where pid=#{sppid}
    </update>
    <select id="getmyjf" resultType="map">
        select  * from t_jf where del='0' and change1='1'and userid=#{pid}
        <if test="pageindex != null and pagesize != null">
            LIMIT #{pageindex},#{pagesize}
        </if>
    </select>
    <select id="getdhCount" resultType="java.lang.Integer">
        select count( * )from t_jf where del='0' and change1='1'and userid=#{pid}
    </select>
    <select id="zyzdetail" parameterType="map" resultType="map">
        select u.name ,u.zyzzt ,z.zyzid,z.zyzname,DATE_FORMAT(z.sq_time ,'%Y-%m-%d ')sq_time,z. reason,z. del,z.  tx
        from t_user u left join t_zyz z on u.pid=z.zyzid
        where u.pid=#{pid} and z.del='0 ' and u.del='0'
 </select>
    <update id="upduser" parameterType="map">
        update t_user set portrait=#{portrait},phone=#{phone},nick=#{nick},type=#{type},name=#{name}
         where pid=#{pid}
    </update>
    <select id="getUserById" parameterType="map" resultType="map">
        select * from t_user where pid=#{pid}
    </select>
    <insert id="zhuce" parameterType="map">
        insert into t_user (
name,
nick,
portrait,
account,
password,
type
)value (
#{name},
#{nick},
#{portrait},
#{phone},
#{mima},
'1'
)
    </insert>
    <select id="getZh" parameterType="map" resultType="int">
        select count(1)
        from t_user where account=#{phone} and del='0'
    </select>
    <select id="getUser" parameterType="map" resultType="map">
        select *
        from t_user where account=#{phone} and del='0'
    </select>
</mapper>
